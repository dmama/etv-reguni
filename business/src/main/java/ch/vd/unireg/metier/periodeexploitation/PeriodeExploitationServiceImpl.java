package ch.vd.unireg.metier.periodeexploitation;

import java.util.ArrayList;
import java.util.Collections;
import java.util.LinkedHashSet;
import java.util.List;
import java.util.Set;

import org.jetbrains.annotations.NotNull;

import ch.vd.registre.base.date.DateRange;
import ch.vd.registre.base.date.DateRangeHelper;
import ch.vd.registre.base.date.RegDate;
import ch.vd.unireg.parametrage.ParametreAppService;
import ch.vd.unireg.regimefiscal.RegimeFiscalConsolide;
import ch.vd.unireg.regimefiscal.RegimeFiscalService;
import ch.vd.unireg.tiers.Entreprise;
import ch.vd.unireg.tiers.ForFiscal;
import ch.vd.unireg.type.CategorieEntreprise;
import ch.vd.unireg.type.GenreImpot;
import ch.vd.unireg.type.TypeAutoriteFiscale;

public class PeriodeExploitationServiceImpl implements PeriodeExploitationService {

	private ParametreAppService parametreAppService;
	private RegimeFiscalService regimeFiscalService;

	@Override
	public @NotNull Set<Integer> determinePeriodesExploitation(@NotNull Entreprise entreprise, @NotNull PeriodeContext context) {

		// allons donc chercher les périodes de couverture des fors vaudois qui intersectent :
		// 1. les années civiles pour lesquelles Unireg doit envoyer les questionnaires SNC (entre la première PF de déclaration PM et l'année courante)
		// 2. les périodes pendant lesquelles l'entreprise a une forme juridique de type SP

		// quand a-t-on du SP ?
		final List<RegimeFiscalConsolide> regimesFiscaux = regimeFiscalService.getRegimesFiscauxVDNonAnnulesTrie(entreprise);
		final List<DateRange> rangesSP = new ArrayList<>(regimesFiscaux.size());
		for (RegimeFiscalConsolide regime : regimesFiscaux) {
			if (regime.getCategorie() == CategorieEntreprise.SP) {
				rangesSP.add(regime);
			}
		}

		// y en a-t-il ?
		if (rangesSP.isEmpty()) {
			return Collections.emptySet();
		}

		// quand génère-t-on des questionnaires SNC ?
		final DateRange periodeGestionUnireg = getPeriodeGestionSNC(context);

		// a-t-on des catégories d'entreprise SP dans la période de gestion par Unireg ?
		final List<DateRange> spDansPeriodeGestion = DateRangeHelper.intersections(periodeGestionUnireg, rangesSP);
		if (spDansPeriodeGestion == null || spDansPeriodeGestion.isEmpty()) {
			return Collections.emptySet();
		}

		// couverture des fors vaudois ?
		final List<ForFiscal> forsFiscaux = entreprise.getForsFiscauxNonAnnules(true);
		final List<ForFiscal> forsVaudois = new ArrayList<>(forsFiscaux.size());
		for (ForFiscal ff : forsFiscaux) {
			if (ff.getTypeAutoriteFiscale() == TypeAutoriteFiscale.COMMUNE_OU_FRACTION_VD && ff.getGenreImpot() == GenreImpot.REVENU_FORTUNE) {
				forsVaudois.add(ff);
			}
		}
		final List<DateRange> couvertureVaudoiseFors = DateRangeHelper.merge(forsVaudois);
		if (couvertureVaudoiseFors == null || couvertureVaudoiseFors.isEmpty()) {
			return Collections.emptySet();
		}

		// couverture des fors vaudois pendant les périodes SP intéressantes ?
		final List<DateRange> spVaudois = DateRangeHelper.intersections(couvertureVaudoiseFors, spDansPeriodeGestion);
		if (spVaudois == null || spVaudois.isEmpty()) {
			return Collections.emptySet();
		}

		// découpons maintenant par année civile ce qui nous reste
		final Set<Integer> periodes = new LinkedHashSet<>();
		for (int annee = periodeGestionUnireg.getDateDebut().year() ; annee <= RegDate.get().year() ; ++ annee) {
			final DateRange anneeCivile = new DateRangeHelper.Range(RegDate.get(annee, 1, 1), RegDate.get(annee, 12, 31));
			if (DateRangeHelper.intersect(anneeCivile, spVaudois)) {
				periodes.add(annee);
			}
		}
		return periodes;
	}

	@NotNull
	private DateRange getPeriodeGestionSNC(@NotNull PeriodeExploitationService.@NotNull PeriodeContext context) {
		final int premiereAnnee;
		switch (context) {
		case ENVOI_AUTO:
			premiereAnnee = parametreAppService.getPremierePeriodeFiscaleDeclarationsPersonnesMorales();
			break;
		case THEORIQUE:
			premiereAnnee = parametreAppService.getPremierePeriodeFiscalePersonnesMorales();
			break;
		default:
			throw new IllegalArgumentException();
		}
		return new DateRangeHelper.Range(RegDate.get(premiereAnnee, 1, 1), null);
	}

	public void setParametreAppService(ParametreAppService parametreAppService) {
		this.parametreAppService = parametreAppService;
	}

	public void setRegimeFiscalService(RegimeFiscalService regimeFiscalService) {
		this.regimeFiscalService = regimeFiscalService;
	}
}
