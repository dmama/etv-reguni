<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans	http://www.springframework.org/schema/beans/spring-beans-3.1.xsd">

	<bean id="migrator" class="ch.vd.uniregctb.migration.pm.Migrator">
		<property name="mode" value="${migration.mode}"/>
		<property name="fromDbFeeder" ref="fromDbFeeder"/>
		<property name="serializationIntermediary" ref="serializationIntermediary"/>
		<property name="migrationWorker" ref="migrationWorker"/>
		<property name="enabled" value="${migrator.enabled}"/>
	</bean>

	<bean id="alreadyMigratedEntrepriseIds" class="ch.vd.uniregctb.migration.pm.mapping.AlreadyMigratedEntrepriseListFactory">
		<property name="uniregTransactionManager" ref="uniregTransactionManager"/>
		<property name="uniregSessionFactory" ref="uniregSessionFactory"/>
	</bean>

	<bean id="fromDbFeeder" class="ch.vd.uniregctb.migration.pm.FromDbFeeder">
		<property name="regpmTransactionManager" ref="regpmTransactionManager"/>
		<property name="sessionFactory" ref="regpmSessionFactory"/>
		<property name="idsEntreprisesDejaMigrees" ref="alreadyMigratedEntrepriseIds"/>
		<property name="nomFichierIdentifiantsAExtraire" value="${migration.test.extracted.pm.file}"/>
	</bean>

	<bean id="serializationIntermediary" class="ch.vd.uniregctb.migration.pm.SerializationIntermediary">
		<property name="fsDirectory" value="${migration.dump.dir}"/>
	</bean>

	<bean id="grapheMigrator" class="ch.vd.uniregctb.migration.pm.engine.GrapheMigrator">
		<property name="uniregTransactionManager" ref="uniregTransactionManager"/>
		<property name="uniregStore" ref="uniregStore"/>
		<property name="entrepriseMigrator" ref="entrepriseMigrator"/>
		<property name="etablissementMigrator" ref="etablissementMigrator"/>
		<property name="individuMigrator" ref="individuMigrator"/>
		<property name="validationInterceptor" ref="validationInterceptor"/>
	</bean>

	<bean id="migrationWorker" class="ch.vd.uniregctb.migration.pm.engine.MigrationWorker">
		<property name="mode" value="${migration.mode}"/>
		<property name="nbThreads" value="${migrator.threads.nb}"/>
		<property name="grapheMigrator" ref="grapheMigrator"/>
	</bean>

	<bean id="entityMigrator" abstract="true" class="ch.vd.uniregctb.migration.pm.engine.AbstractEntityMigrator">
        <constructor-arg name="uniregStore" ref="uniregStore"/>
		<constructor-arg name="activityManager" ref="activityManager"/>
	</bean>

	<bean id="entrepriseMigrator" class="ch.vd.uniregctb.migration.pm.engine.EntrepriseMigrator" parent="entityMigrator">
        <constructor-arg name="bouclementService" ref="bouclementService"/>
		<constructor-arg name="assujettissementService" ref="assujettissementService"/>
        <constructor-arg name="rcEntAdapter" ref="rcEntAdapter"/>
        <constructor-arg name="adresseHelper" ref="adresseHelper"/>
	</bean>

	<bean id="etablissementMigrator" class="ch.vd.uniregctb.migration.pm.engine.EtablissementMigrator" parent="entityMigrator">
        <constructor-arg name="rcEntAdapter" ref="rcEntAdapter"/>
        <constructor-arg name="adresseHelper" ref="adresseHelper"/>
	</bean>

    <bean id="adresseHelper" class="ch.vd.uniregctb.migration.pm.engine.helpers.AdresseHelper">
        <constructor-arg name="streetDataMigrator" ref="streetDataMigrator"/>
    </bean>

    <bean id="individuMigrator" class="ch.vd.uniregctb.migration.pm.engine.IndividuMigrator" parent="entityMigrator">
	    <constructor-arg name="tiersDAO" ref="tiersDAO"/>
	    <constructor-arg name="rcpersClient" ref="rcpersClient"/>
	    <constructor-arg name="nonHabitantIndex" ref="nonHabitantIndex"/>
	</bean>

	<bean id="noOrdrePosteProvider" class="ch.vd.uniregctb.migration.pm.adresse.NoOrdrePosteProvider">
		<constructor-arg value="${mapping.noOrdreP.file}"/>
	</bean>

	<bean id="activityManager" class="ch.vd.uniregctb.migration.pm.engine.ActivityManagerImpl">
		<constructor-arg name="filename" value="${activite.flag.perception.file}"/>
		<constructor-arg name="seuilActivite" ref="dateSeuilActivite"/>
	</bean>

	<bean id="dateSeuilActivite" class="ch.vd.uniregctb.migration.pm.utils.RegDateFactory">
		<constructor-arg name="format" value="DISPLAY"/>
		<constructor-arg name="value" value="${activite.flag.seuil}"/>
	</bean>

	<bean id="streetDataMigrator" class="ch.vd.uniregctb.migration.pm.adresse.StreetDataMigratorImpl">
		<property name="fidorClient" ref="fidorClient"/>
		<property name="mappingNosOrdrePoste" ref="noOrdrePosteProvider"/>
	</bean>

	<bean id="nonHabitantIndex" class="ch.vd.uniregctb.migration.pm.indexeur.NonHabitantIndex">
		<property name="index">
			<bean class="ch.vd.uniregctb.migration.pm.indexeur.IndexImpl">
				<constructor-arg name="indexPath" value="${indexeur.nh.dir}"/>
			</bean>
		</property>
	</bean>

	<bean id="migrationInitializer" class="ch.vd.uniregctb.migration.pm.MigrationInitializer">
		<property name="nonHabitantIndex" ref="nonHabitantIndex"/>
		<property name="nonHabitantIndexToBeCleared" value="${indexeur.nh.create}"/>
		<property name="registrar" ref="migrator"/>
		<property name="uniregTransactionManager" ref="uniregTransactionManager"/>
		<property name="uniregSessionFactory" ref="uniregSessionFactory"/>
	</bean>

</beans>
